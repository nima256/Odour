<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>سبد خرید</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/vazir-font/30.1.0/font-face.css"
    />
    <style>
      body {
        font-family: "Vazir", sans-serif;
        background-color: #f8f9fa;
      }
      .cart-button {
        background-color: #2563eb;
        color: white;
        padding: 1rem;
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        border: none;
        cursor: pointer;
      }

      .cart-button:hover {
        background-color: #1d4ed8;
        transform: scale(1.05);
      }

      .cart-button:focus {
        outline: none;
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5);
      }

      .cart-button.success {
        background-color: #16a34a;
      }

      .cart-button.success:hover {
        background-color: #15803d;
      }

      .icon {
        width: 2rem;
        height: 2rem;
      }

      .hidden {
        display: none;
      }

      svg {
        stroke: currentColor;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
        fill: none;
      }

      .logo-container {
        --logo-size: 2.5rem;
      }

      .logo {
        width: var(--logo-size);
        height: var(--logo-size);
      }

      .nav-link {
        transition: all 0.3s ease;
        position: relative;
      }

      .nav-link::after {
        content: "";
        position: absolute;
        width: 0;
        height: 2px;
        bottom: -4px;
        right: 50%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        transition: all 0.3s ease;
      }

      .nav-link:hover::after {
        width: 100%;
        right: 0;
      }

      .icon-btn {
        transition: all 0.3s ease;
      }

      .icon-btn:hover {
        transform: translateY(-2px);
      }

      .mobile-menu {
        transition: all 0.3s ease;
        transform: translateX(100%);
        opacity: 0;
      }

      .mobile-menu.active {
        transform: translateX(0);
        opacity: 1;
      }
      .page {
        display: none;
      }

      .active-page {
        display: block;
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: #3b82f6;
      }

      .product-image {
        width: 80px;
        height: 80px;
        background-color: #f3f4f6;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .product-image svg {
        width: 60px;
        height: 60px;
      }
    </style>
  </head>
  <nav
    class="fixed top-0 right-0 left-0 bg-white shadow-md z-50 px-4 md:px-6 py-3"
  >
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <!-- Logo -->
      <a href="#" class="flex items-center order-2 md:order-1 h-12 md:h-14">
        <div class="h-full overflow-hidden flex items-center">
          <img
            src="/logo.png"
            alt="لوگوی گلو بیوتی"
            class="h-full w-auto object-contain"
          />
        </div>
      </a>

      <!-- Desktop Menu -->
      <div
        class="hidden md:flex items-center space-x-8 space-x-reverse order-1 md:order-2"
      >
        <a
          href="/"
          class="nav-link text-gray-800 hover:text-pink-500 transition-colors"
          >خانه</a
        >
        <a
          href="/shop"
          class="nav-link text-gray-800 hover:text-pink-500 transition-colors"
          >فروشگاه</a
        >
        <a
          href="#"
          class="nav-link text-gray-800 hover:text-pink-500 transition-colors"
          >دسته‌بندی‌ها</a
        >
        <a
          href="/weblog"
          class="nav-link text-gray-800 hover:text-pink-500 transition-colors"
          >وبلاگ</a
        >
        <a
          href="#"
          class="nav-link text-gray-800 hover:text-pink-500 transition-colors"
          >درباره ما</a
        >
        <a
          href="#"
          class="nav-link text-gray-800 hover:text-pink-500 transition-colors"
          >تماس با ما</a
        >
      </div>

      <!-- Icons -->
      <div
        class="flex items-center space-x-4 space-x-reverse order-1 md:order-3"
      >
        <div class="relative">
          <button
            onclick="window.location.href='/cart';"
            class="relative text-gray-700 hover:text-pink-500 transition-colors"
          >
            <i class="fas fa-shopping-bag text-xl"></i>
          </button>
        </div>
        <button
          id="user-auth-button"
          class="text-gray-700 hover:text-pink-500 transition-colors"
        >
          <i class="fas fa-user text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div
      id="mobile-menu"
      class="md:hidden hidden bg-white absolute right-0 left-0 top-full shadow-md"
    >
      <div class="flex flex-col px-4 py-2">
        <a
          href="/"
          class="py-2 text-gray-800 hover:text-pink-500 transition-colors"
          >خانه</a
        >
        <a
          href="/shop"
          class="py-2 text-gray-800 hover:text-pink-500 transition-colors"
          >فروشگاه</a
        >
        <a
          href="#"
          class="py-2 text-gray-800 hover:text-pink-500 transition-colors"
          >دسته‌بندی‌ها</a
        >
        <a
          href="/weblog"
          class="py-2 text-gray-800 hover:text-pink-500 transition-colors"
          >وبلاگ</a
        >
        <a
          href="#"
          class="py-2 text-gray-800 hover:text-pink-500 transition-colors"
          >درباره ما</a
        >
        <a
          href="#"
          class="py-2 text-gray-800 hover:text-pink-500 transition-colors"
          >تماس با ما</a
        >
      </div>
    </div>
  </nav>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const mobileMenuButton = document.getElementById("mobile-menu-button");
      const mobileMenu = document.getElementById("mobile-menu");

      mobileMenuButton.addEventListener("click", function () {
        mobileMenu.classList.toggle("hidden");
      });

      // بستن منو هنگام کلیک خارج از آن
      document.addEventListener("click", function (event) {
        if (
          !mobileMenu.contains(event.target) &&
          event.target !== mobileMenuButton
        ) {
          mobileMenu.classList.add("hidden");
        }
      });
    });
  </script>
  <br /><br />
  <div class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
      <!-- Cart Page -->
      <% if (cartItems.length === 0) {%>
      <div id="cart-page" class="page active-page mt-5">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1
            class="text-2xl font-bold text-gray-800 mb-6 text-right"
            style="text-align: center"
          >
            سبد خرید شما خالی است
          </h1>
        </div>
      </div>
      <% } else {%>
      <div id="cart-page" class="page active-page mt-5 mb-5">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 class="text-2xl font-bold text-gray-800 mb-6 text-right">
            سبد خرید
          </h1>

          <div class="space-y-6 mb-8" id="cart-items">
            <!-- Products will be added here by JavaScript -->
          </div>

          <div class="border-t border-gray-200 pt-4 mt-6">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center space-x-2 space-x-reverse">
                <input
                  type="text"
                  id="discount-code"
                  placeholder="کد تخفیف"
                  class="border border-gray-300 rounded-md px-3 py-2 text-right"
                />
                <button
                  id="apply-discount"
                  class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition"
                >
                  اعمال
                </button>
              </div>
              <div class="text-gray-600">کد تخفیف</div>
            </div>

            <div class="flex justify-between items-center mb-2">
              <div class="font-bold text-xl text-gray-800" id="subtotal">
                0 تومان
              </div>
              <div class="text-gray-600">جمع کل</div>
            </div>
            
            <div
              id="discount-row"
              class="hidden flex justify-between items-center mb-2 py-2"
            >
              <div class="text-gray-600">
                تخفیف (<span id="discount-code-display"></span>)
              </div>
              <div
                id="discount-amount"
                class="text-green-600 font-medium"
              ></div>
            </div>

            <div
              class="flex justify-between items-center mb-2 border-t border-gray-200 pt-2"
            >
              <div class="font-bold text-xl text-blue-700" id="total">
                0 تومان
              </div>
              <div class="text-gray-600">مبلغ قابل پرداخت</div>
            </div>
          </div>
        </div>

        <div class="text-left">
          <button
            id="next-step"
            class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition text-lg"
          >
            ادامه فرآیند خرید <span class="mr-2">→</span>
          </button>
        </div>
      </div>
      <% } %>
      <!-- Shipping Page -->
      <div id="shipping-page" class="page">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 class="text-2xl font-bold text-gray-800 mb-6 text-right">
            اطلاعات ارسال
          </h1>
          <form action="/api/order" method="post" id="order-form">
            <div class="space-y-4 mb-6">
              <div class="flex flex-col">
                <label class="text-gray-600 mb-1 text-right"
                  >نام و نام خانوادگی</label
                >
                <input
                  type="text"
                  id="full-name"
                  class="border border-gray-300 rounded-md px-3 py-2 text-right"
                  disabled
                  placeholder="<%= user.fullName %>"
                />
              </div>

              <div class="flex flex-col">
                <label class="text-gray-600 mb-1 text-right">کد پستی</label>
                <input
                  type="text"
                  name="postcode"
                  id="postal-code"
                  class="border border-gray-300 rounded-md px-3 py-2 text-right"
                />
              </div>
              <div class="flex flex-col">
                <label class="text-gray-600 mb-1 text-right">آدرس</label>
                <textarea
                  id="address"
                  name="address"
                  rows="3"
                  class="border border-gray-300 rounded-md px-3 py-2 text-right"
                ></textarea>
              </div>

              <div class="flex flex-col">
                <label class="text-gray-600 mb-1 text-right">شماره تماس</label>
                <input
                  type="tel"
                  id="phone"
                  class="border border-gray-300 rounded-md px-3 py-2 text-right"
                  disabled
                  placeholder="<%= user.mobile %>"
                />
              </div>

              <div class="flex flex-col">
                <label class="text-gray-600 mb-1 text-right">روش ارسال</label>
                <select
                  id="shipping-method"
                  class="border border-gray-300 rounded-md px-3 py-2 text-right"
                  name="delivery"
                >
                  <option value="تیپاکس">تیپاکس</option>
                  <option value="چاپار">چاپار</option>
                  <option value="ایران-پیام">ایران پیام</option>
                </select>
              </div>
            </div>
          </form>
        </div>

        <div class="flex justify-between">
          <button
            id="go-to-summary"
            class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition text-lg"
          >
            مشاهده خلاصه سفارش <span class="mr-2">→</span>
          </button>
          <button
            id="back-to-cart"
            class="bg-gray-500 text-white px-6 py-3 rounded-md hover:bg-gray-600 transition text-lg"
          >
            <span class="ml-2">←</span> بازگشت
          </button>
        </div>
      </div>

      <!-- Summary Page -->
      <div id="summary-page" class="page">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
          <h1 class="text-2xl font-bold text-gray-800 mb-6 text-right">
            خلاصه سفارش
          </h1>

          <div class="space-y-4 mb-6">
            <div class="border-b border-gray-200 pb-4">
              <h2 class="text-lg font-bold text-gray-700 mb-3 text-right">
                اطلاعات خریدار
              </h2>
              <div
                class="text-gray-600 text-right"
                id="summary-customer-info"
              ></div>
            </div>

            <div class="border-b border-gray-200 pb-4">
              <h2 class="text-lg font-bold text-gray-700 mb-3 text-right">
                محصولات
              </h2>
              <div id="summary-products" class="space-y-4"></div>
            </div>

            <div>
              <div class="flex justify-between items-center mb-2">
                <div class="text-gray-800" id="summary-subtotal">0 تومان</div>
                <div class="text-gray-600">جمع کل</div>
              </div>

              <div
                id="summary-discount-row"
                class="hidden flex justify-between py-2"
              >
                <div class="text-gray-600">
                  تخفیف (<span id="summary-discount-code"></span>)
                  <div class="text-xs text-gray-500 mt-1">
                    نوع تخفیف: <span id="summary-discount-type"></span>
                  </div>
                </div>
                <div
                  id="summary-discount"
                  class="text-green-600 font-medium"
                ></div>
              </div>

              <div
                id="summary-min-order-row"
                class="hidden flex justify-between py-2 text-xs text-gray-500"
              >
                <div class="text-gray-500 mt-1" style="font-size: 15px;">حداقل مبلغ سفارش برای تخفیف:</div>
                <div  style="font-size: 15px;" id="summary-min-order"></div>
              </div>

              <div
                class="flex justify-between py-4 border-t border-gray-200 font-bold"
              >
                <div class="text-gray-500 mt-1"">جمع کل:</div>
                <div id="summary-total"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-between">
          <button
            id="complete-purchase"
            class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition text-lg"
          >
            تکمیل خرید و پرداخت
          </button>
          <button
            id="back-to-shipping"
            class="bg-gray-500 text-white px-6 py-3 rounded-md hover:bg-gray-600 transition text-lg"
          >
            <span class="ml-2">←</span> بازگشت
          </button>
        </div>
      </div>

      <!-- Confirmation Page -->
      <div id="confirmation-page" class="page">
        <div class="bg-white rounded-lg shadow-lg p-8 mb-6 text-center">
          <div
            class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-12 w-12 text-green-600"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 13l4 4L19 7"
              />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-gray-800 mb-4">
            سفارش شما با موفقیت ثبت شد
          </h1>
          <p class="text-gray-600 mb-6">
            از خرید شما متشکریم. جزئیات سفارش به ایمیل شما ارسال خواهد شد.
          </p>
          <div class="bg-gray-50 p-4 rounded-lg mb-6">
            <p class="text-gray-700 font-bold">
              شماره سفارش: <span class="font-normal" id="order-number"></span>
            </p>
          </div>
          <a href="/userProfile">
            <button
              id="back-to-shop"
              class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition text-lg"
            >
              رهگیری سفارش
            </button>
          </a>
        </div>
      </div>
    </div>
    <footer class="bg-gray-900 text-white py-12">
      <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <div class="flex items-center space-x-reverse space-x-3 mb-4">
              <div
                class="w-10 h-10 bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg flex items-center justify-center"
              >
                <svg
                  class="w-6 h-6 text-white"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                  ></path>
                </svg>
              </div>
              <h3 class="text-xl font-bold">وبلاگ مدرن</h3>
            </div>
            <p class="text-gray-400 text-sm leading-relaxed">
              مرجع آموزش تکنولوژی، طراحی وب و برنامه‌نویسی در ایران
            </p>
          </div>
          <div>
            <h4 class="font-bold mb-4">دسته‌بندی‌ها</h4>
            <ul class="space-y-2 text-sm text-gray-400">
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >طراحی وب</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >برنامه‌نویسی</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-white transition-colors">UI/UX</a>
              </li>
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >هوش مصنوعی</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="font-bold mb-4">لینک‌های مفید</h4>
            <ul class="space-y-2 text-sm text-gray-400">
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >درباره ما</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >تماس با ما</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >حریم خصوصی</a
                >
              </li>
              <li>
                <a href="#" class="hover:text-white transition-colors"
                  >شرایط استفاده</a
                >
              </li>
            </ul>
          </div>
          <div>
            <h4 class="font-bold mb-4">شبکه‌های اجتماعی</h4>
            <div class="flex space-x-reverse space-x-4">
              <a
                href="#"
                class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-gray-700 transition-colors"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"
                  />
                </svg>
              </a>
              <a
                href="#"
                class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-gray-700 transition-colors"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M22.46 6c-.77.35-1.6.58-2.46.69.88-.53 1.56-1.37 1.88-2.38-.83.5-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98C8.28 9.09 5.11 7.38 3 4.79c-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.56-.71 0-1.37-.2-1.95-.5v.03c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.93.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21 16 21 20.33 14.46 20.33 8.79c0-.19 0-.37-.01-.56.84-.6 1.56-1.36 2.14-2.23z"
                  />
                </svg>
              </a>
              <a
                href="#"
                class="w-10 h-10 bg-gray-800 rounded-lg flex items-center justify-center hover:bg-gray-700 transition-colors"
              >
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"
                  />
                </svg>
              </a>
            </div>
          </div>
        </div>
        <div
          class="border-t border-gray-800 mt-8 pt-8 text-center text-sm text-gray-400"
        >
          <p>&amp;copy; ۱۴۰۳ وبلاگ مدرن. تمامی حقوق محفوظ است.</p>
        </div>
      </div>
    </footer>
    
    <script>
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed z-50 px-4 py-3 rounded-lg shadow-lg text-white text-sm sm:text-base ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 
            'bg-blue-500'
        }`;
        
        // Mobile: centered at top, Desktop: top-right
        notification.className += ' top-4 left-1/2 -translate-x-1/2 sm:left-auto sm:translate-x-0 sm:top-6 sm:right-6';
        
        // Width control
        notification.className += ' w-[calc(100%-2rem)] max-w-xs sm:max-w-sm';
        
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Animation in
        notification.classList.add('transform', 'transition-all', 'duration-300');
        notification.classList.add('translate-y-2', 'opacity-0');
        
        setTimeout(() => {
            notification.classList.remove('translate-y-2', 'opacity-0');
        }, 10);
        
        setTimeout(() => {
            notification.classList.add('opacity-0', 'translate-y-2');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

      const cartItemsFromServer = <%- JSON.stringify(cartItems) %>;

      let appliedDiscount = 0;
      let currentDiscountCode = null;
      let discountRules = null;


      // Apply discount code
      async function applyDiscountCode() {
        const codeInput = document.getElementById("discount-code");
        const code = codeInput.value.trim();

        if (!code) {
          showNotification("لطفا کد تخفیف را وارد کنید", 'error');
          return;
        }

        if (currentDiscountCode === code && isDiscountStillValid()) {
          showNotification("این کد تخفیف قبلاً اعمال شده است", 'error');
          return;
        }

        const subtotal = calculateSubtotal();

        try {
          const response = await fetch("/api/cart/apply-discount", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              discountCode: code,
              subtotal: subtotal,
            }),
          });

          const data = await response.json();

          if (data.success) {
            // تغییرات اینجا - دریافت مقدار محاسبه شده از سرور
            appliedDiscount = data.discount.calculatedAmount; // استفاده از calculatedAmount به جای amount
            currentDiscountCode = code;
            discountRules = {
              minOrderAmount: data.discount.minOrderAmount || 0,
              type: data.discount.type,
              originalValue: data.discount.originalValue,
              amount: data.discount.amount,
              maxDiscountAmount: data.discount.maxDiscountAmount || Infinity,
              calculatedAmount: data.discount.calculatedAmount // اضافه کردن این خط
            };

            showNotification(data.message, 'success');
            updateTotals();
          } else {
            resetDiscount();
            showNotification(data.message, 'error');
            updateTotals();
          }
        } catch (err) {
          console.error("Error:", err);
          showNotification("مشکلی در ارتباط با سرور به وجود آمده است", 'error');
        }
      }

      function isDiscountStillValid() {
        if (!discountRules) return false;

        const subtotal = calculateSubtotal();

        // بررسی حداقل مبلغ سفارش
        if (discountRules.minOrderAmount && subtotal < discountRules.minOrderAmount) {
          return false;
        }

        return true;
      }


      function calculateDiscountAmount(subtotal) {
        if (!currentDiscountCode || !isDiscountStillValid()) {
          return 0;
        }

        if (discountRules.type === "percent") {
          // محاسبه مقدار تخفیف بر اساس درصد
          const percentAmount = Math.floor((subtotal * discountRules.amount) / 100);

          // اگر سقف تخفیف مشخص شده باشد، مقدار کمتر را انتخاب می‌کنیم
          return discountRules.maxDiscountAmount
            ? Math.min(percentAmount, discountRules.maxDiscountAmount)
            : percentAmount;
        }

        // برای تخفیف مبلغ ثابت
        return discountRules.amount;
      }

      // Format price in Toman
      function formatPrice(price) {
        return new Intl.NumberFormat("fa-IR").format(price) + " تومان";
      }

      // Calculate subtotal
      function calculateSubtotal() {
        return cartItemsFromServer.reduce((total, product) => {
          const price = product.offerPrice ?? product.price;
          return total + (price * product.quantity);
        }, 0);
      }

      // Calculate total
      function calculateTotal() {
        return calculateSubtotal() - appliedDiscount;
      }

      // Calculate final total (including shipping)
      function calculateFinalTotal() {
        return calculateTotal();
      }

      function toPersianDigits(str) {
          return str.toString().replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
      }

      // Render cart items
      function renderCartItems() {
          const cartItemsContainer = document.getElementById("cart-items");
          const cartTotalsSection = document.querySelector(".border-t.border-gray-200.pt-4.mt-6"); // بخش محاسبات قیمت
          
          cartItemsContainer.innerHTML = "";

          // Check if cart is empty
          if (cartItemsFromServer.length === 0) {
              cartItemsContainer.innerHTML = `
                  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                      <h1 class="text-2xl font-bold text-gray-800 mb-6 text-center">
                          سبد خرید شما خالی است
                      </h1>
                  </div>
              `;
              
              // Hide the checkout button and totals section
              const nextStepBtn = document.getElementById("next-step");
              if (nextStepBtn) nextStepBtn.style.display = "none";
              if (cartTotalsSection) cartTotalsSection.style.display = "none";
              
              // Update totals (which will set discount to 0 if any)
              updateTotals();
              return;
          }

          // Show the totals section if it was hidden
          if (cartTotalsSection) cartTotalsSection.style.display = "block";

          // Rest of your existing cart items rendering code
        cartItemsFromServer.forEach((product) => {
          let forPrice = product.price * product.quantity
          let forOfferPrice = product.offerPrice * product.quantity

          const itemElement = document.createElement("div");
          itemElement.className =
            "flex flex-col md:flex-row justify-between items-start md:items-center border-b border-gray-200 pb-4";
          itemElement.innerHTML = `
                <div class="flex items-start mb-4 md:mb-0">
                    <div class="product-image ml-4">
                      <img src="${product.image}" alt="">
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800 text-right">${
                          product.name
                        }</h3>

                        ${
                        product.offerPrice
                            ? `
                              <div class="text-gray-600 line-through text-sm text-right">${formatPrice(product.price)}</div>
                              <div class="price-gradient font-bold text-xl text-right">${formatPrice(product.offerPrice)}</div>
                            `
                            : `
                              <p class="text-gray-600 text-right">${formatPrice(product.price)}</p>
                            `
                        }
                    </div>
                </div>
                <div class="flex items-center self-end md:self-auto">
                    <div class="flex items-center border border-gray-300 rounded-md overflow-hidden ml-4">
                        <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 transition" onclick="updateQuantity('${product._id}', ${product.quantity + 1})">+</button>
                        <span class="px-4 py-1">${toPersianDigits(product.quantity)}</span>
                        <button class="px-3 py-1 bg-gray-100 hover:bg-gray-200 transition" onclick="updateQuantity('${product._id}', ${product.quantity - 1})" ${product.quantity <= 1 ? "disabled" : ""}>-</button>
                    </div>
                    <div id="product-total-${product._id}" class="font-bold text-gray-800">${product.offerPrice ? formatPrice(forOfferPrice) : formatPrice(forPrice)}</div>
                    <button onclick="deleteProduct('${product._id}')" class="action-btn p-1 md:p-2 text-red-600 hover:bg-red-50 rounded-full transition-all">
                        <i class="fas fa-trash text-sm"></i>
                    </button>
                </div>
            `;
          cartItemsContainer.appendChild(itemElement);
        });

          // Show the checkout button if it was hidden
          const nextStepBtn = document.getElementById("next-step");
          if (nextStepBtn) nextStepBtn.style.display = "block";
          
          // Update totals
          updateTotals();
      }


        function deleteProduct(id) {
            if (confirm('آیا از حذف این محصول اطمینان دارید؟')) {
                fetch(`/api/cart/remove/${id}`, {
                    method: "DELETE",
                })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        // 1. Remove the item from cartItemsFromServer
                        const index = cartItemsFromServer.findIndex(item => item._id === id);
                        if (index !== -1) {
                            cartItemsFromServer.splice(index, 1);
                        }
                        
                        // 2. Update totals and re-render
                        updateTotals();
                        renderCartItems();
                        showNotification("محصول از سبد خرید شما حذف شد", 'success');
                    } else {
                        showNotification(data.message, 'error');
                    }
                })
                .catch((err) => {
                    console.error("Error:", err);
                    showNotification("مشکلی در ارتباط با سرور به وجود آمده است", 'error');
                });
            }
        }


        // Update totals display
        function updateTotals() {
          const subtotal = calculateSubtotal();

          // محاسبه مجدد تخفیف بر اساس قوانین و مبلغ فعلی
          appliedDiscount = isDiscountStillValid() ? calculateDiscountAmount(subtotal) : 0;

          // اگر تخفیف نامعتبر شد، پیام نمایش دهید
          if (currentDiscountCode && !isDiscountStillValid()) {
            showNotification(`کد تخفیف ${currentDiscountCode} به دلیل تغییر در سبد خرید دیگر قابل استفاده نیست`, 'error');
            resetDiscount();
          }

          const total = subtotal - appliedDiscount;

          document.getElementById("subtotal").textContent = formatPrice(subtotal);
          document.getElementById("total").textContent = formatPrice(total);

          if (appliedDiscount > 0) {
            document.getElementById("discount-row").classList.remove("hidden");
            document.getElementById("discount-amount").textContent =
              "- " + formatPrice(appliedDiscount);
            document.getElementById("discount-code-display").textContent =
              currentDiscountCode;
          } else {
            document.getElementById("discount-row").classList.add("hidden");
            currentDiscountCode = null;
            discountRules = null;
          }
        }

        function resetDiscount() {
          appliedDiscount = 0;
          currentDiscountCode = null;
          discountRules = null;
          document.getElementById("discount-code").value = "";
        }

      // Update product quantity
        function updateQuantity(productId, newQuantity) {
          if (newQuantity < 1) return;

          fetch("/api/cart/update", {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              productId,
              quantity: newQuantity
            }),
          })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              const item = cartItemsFromServer.find(item => item._id === productId);
              if (item) {
                item.quantity = newQuantity;
              }
              const totalEl = document.getElementById(`product-total-${productId}`);
              if (totalEl && item) {
                const price = item.offerPrice || item.price;
                totalEl.textContent = formatPrice(price * newQuantity);
              }
              updateTotals();
              renderCartItems();
            } else {
              showNotification(data.message, 'error');
            }
          })
          .catch((err) => {
            console.error("Error:", err);
            showNotification("مشکلی در ارتباط با سرور به وجود آمده است", 'error');
          });
        }


      // Render summary page
      function renderSummary() {
        const fullName = document.getElementById("full-name").getAttribute("placeholder");
        const postalCode = document.getElementById("postal-code").value;
        const address = document.getElementById("address").value;
        let finalShiping;
        const shipping = document.getElementById("shipping-method").value;
        if (shipping === "تیپاکس") {
          finalShiping = "تیپاکس"
        }
        else if (shipping === "چاپار") {
          finalShiping = "چاپار"
        }
        else if (shipping === "ایران-پیام") {
          finalShiping = "ایران-پیام"
        }
        const phone = document.getElementById("phone").getAttribute("placeholder");

        document.getElementById("summary-customer-info").innerHTML = `
            <p>${fullName}</p>
            <p>کد پستی: ${postalCode}</p>
            <p>آدرس: ${address}</p>
            <p>تلفن: ${phone}</p>
            <p>روش ارسال: ${finalShiping}</p>
        `;

        const summaryProducts = document.getElementById("summary-products");
        summaryProducts.innerHTML = "";

        cartItemsFromServer.forEach((product) => {
          let forPrice = product.price * product.quantity
          let forOfferPrice = product.offerPrice * product.quantity

          const itemTotal = product.price * product.quantity;
          const productElement = document.createElement("div");
          productElement.className = "flex justify-between items-center";
          productElement.innerHTML = `
                <div class="flex items-center">
                    <div class="product-image ml-4" style="width: 50px; height: 50px;">
                        <img src="${product.image}" alt="">
                    </div>
                    <div class="text-gray-800">${product.offerPrice ? formatPrice(forOfferPrice) : formatPrice(forPrice)}</div>
                </div>
                <div class="text-gray-600 text-right">${product.name} × ${
            product.quantity
          }</div>
            `;
          summaryProducts.appendChild(productElement);
        });

        const subtotal = calculateSubtotal();
        const finalTotal = calculateFinalTotal();

        document.getElementById("summary-subtotal").textContent =
          formatPrice(subtotal);
        document.getElementById("summary-total").textContent =
          formatPrice(finalTotal);

          if (appliedDiscount > 0) {
              document.getElementById("summary-discount-row").classList.remove("hidden");
              document.getElementById("summary-discount").textContent = "- " + formatPrice(appliedDiscount);

              // نمایش کد تخفیف اعمال شده
              document.getElementById("summary-discount-code").textContent = currentDiscountCode;

              // نمایش نوع تخفیف (درصدی یا مبلغی)
              const discountTypeText = discountRules.type === "percent"
                  ? `${discountRules.amount}%`
                  : formatPrice(discountRules.amount);
              document.getElementById("summary-discount-type").textContent = discountTypeText;

              // نمایش حداقل مبلغ سفارش برای تخفیف (در صورت وجود)
              if (discountRules.minOrderAmount) {
                  document.getElementById("summary-min-order").textContent = formatPrice(discountRules.minOrderAmount);
                  document.getElementById("summary-min-order-row").classList.remove("hidden");
              } else {
                  document.getElementById("summary-min-order-row").classList.add("hidden");
              }
          } else {
              document.getElementById("summary-discount-row").classList.add("hidden");
              document.getElementById("summary-min-order-row").classList.add("hidden");
          }
        }

      // Navigation between pages
      function showPage(pageId) {
        document.querySelectorAll(".page").forEach((page) => {
          page.classList.remove("active-page");
        });
        document.getElementById(pageId).classList.add("active-page");

        if (pageId === "summary-page") {
          renderSummary();
        }

        if (pageId === "confirmation-page") {
          document.getElementById("order-number").textContent = "<%= OrderNum %>"
        }

        window.scrollTo(0, 0);
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        renderCartItems();

        document
          .getElementById("apply-discount")
          .addEventListener("click", applyDiscountCode);
        document
          .getElementById("next-step")
          .addEventListener("click", () => showPage("shipping-page"));
        document
          .getElementById("back-to-cart")
          .addEventListener("click", () => showPage("cart-page"));
        document
          .getElementById("go-to-summary")
          .addEventListener("click", () => {
              showPage("summary-page");
          });

        document
          .getElementById("back-to-shipping")
          .addEventListener("click", () => showPage("shipping-page"));
        document
          .getElementById("complete-purchase")
          .addEventListener("click", () => {

            const fullName = document.getElementById("full-name").value;
            const postalCode = document.getElementById("postal-code").value;
            const address = document.getElementById("address").value;
            const phone = document.getElementById("phone").value;
            const orderForm = document.getElementById("order-form");
            const formDataOrder = new FormData(orderForm);

            function validatePostalCode(postalCode) {
            const regex = /^\d{10}$/;
            if (!regex.test(postalCode)) {
              showNotification("کد پستی باید دقیقاً ۱۰ رقم باشد", 'error');
              return false;
            }
            return true;
          }

          // اعتبارسنجی آدرس
          function validateAddress(address) {
            if (address.length < 10) {
              showNotification("آدرس نمی‌تواند کمتر از ۱۰ کاراکتر باشد", 'error');
              return false;
            }
            
            if (address.length > 500) {
              showNotification("آدرس نمی‌تواند بیشتر از ۵۰۰ کاراکتر باشد", 'error');
              return false;
            }
            
            return true;
            }


            if (!postalCode || !address) {
              showNotification("لطفاً تمام فیلدها را پر کنید", 'error');
              return;
            }


            if (!validatePostalCode(postalCode)) {
              return;
            }

            // اعتبارسنجی آدرس
            if (!validateAddress(address)) {
              return;
            }


              fetch("/api/order", {
                method: "POST",
                body: formDataOrder,
              })
                .then((res) => res.json())
                .then((data) => {
                  if (data.success) {
                    // Only run this if registration was successful
                    showPage("confirmation-page")
                  } else {
                    // Show error message
                    showNotification(data.message, 'error');
                  }
                })
                .catch((err) => {
                  console.error("Error:", err);
                  showNotification("مشکلی در ارتباط با سرور به وجود آمده است", 'error');
                });
          });
        document
          .getElementById("back-to-shop")
          .addEventListener("click", () => showPage("cart-page"));
      });
    </script>
  </div>
</html>